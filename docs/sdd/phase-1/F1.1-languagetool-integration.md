# F1.1: LanguageTool Integration

**Feature ID:** F1.1
**Priority:** P0 (MVP)
**Status:** Not Started
**Package:** `@writeforge/core-grammar`

---

## Overview

Integrate LanguageTool as the primary grammar and spelling checking engine. LanguageTool provides 80-90% of Grammarly's accuracy with full offline capability and self-hosting support.

### Goals

1. Provide fast grammar/spelling/punctuation checking (<100ms latency)
2. Support 30+ languages out of the box
3. Enable 100% offline operation
4. Create reusable client library for all platforms

### Non-Goals

- AI-powered contextual suggestions (handled by F1.4)
- Custom style rules beyond LanguageTool defaults (handled by F2.9)
- Cloud-based LanguageTool API (local only)

---

## Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                    Consumer Applications                     │
│  (Chrome Extension, macOS Desktop, Windows Desktop, etc.)   │
└─────────────────────────────────┬───────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────┐
│                 @writeforge/core-grammar                     │
│  ┌──────────────────┐  ┌──────────────────┐                 │
│  │ LanguageToolClient│  │  GrammarService  │                │
│  │  - check()        │  │  - check()       │                │
│  │  - languages()    │  │  - batchCheck()  │                │
│  │  - health()       │  │  - getCached()   │                │
│  └────────┬─────────┘  └────────┬─────────┘                │
│           │                     │                           │
│           └─────────┬───────────┘                           │
│                     ▼                                       │
│  ┌──────────────────────────────────────────────────────┐  │
│  │                    Cache Layer                        │  │
│  │            (LRU cache for repeat checks)              │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────┬───────────────────────────┘
                                  │
                                  ▼
┌─────────────────────────────────────────────────────────────┐
│                  LanguageTool Server                         │
│                  (localhost:8010)                            │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  Docker: erikvl87/languagetool                        │  │
│  │  - Grammar rules engine                               │  │
│  │  - Spelling dictionaries                              │  │
│  │  - N-gram data (optional, +accuracy)                  │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

---

## Data Models

### GrammarCheck

```typescript
interface GrammarCheck {
  /** Original text that was checked */
  text: string;

  /** Language used for checking (e.g., "en-US") */
  language: string;

  /** Array of issues found */
  issues: GrammarIssue[];

  /** Check duration in milliseconds */
  durationMs: number;

  /** Whether result came from cache */
  cached: boolean;
}
```

### GrammarIssue

```typescript
interface GrammarIssue {
  /** Unique identifier for this issue */
  id: string;

  /** Category of issue */
  type: 'grammar' | 'spelling' | 'punctuation' | 'style' | 'typography';

  /** LanguageTool rule ID (e.g., "MORFOLOGIK_RULE_EN_US") */
  ruleId: string;

  /** Human-readable message explaining the issue */
  message: string;

  /** Short message for tooltips */
  shortMessage: string;

  /** Character offset where issue starts */
  offset: number;

  /** Length of the problematic text */
  length: number;

  /** The problematic text */
  context: string;

  /** Suggested replacements (may be empty for some issues) */
  replacements: string[];

  /** URL for more information (optional) */
  moreInfoUrl?: string;

  /** Issue severity for UI styling */
  severity: 'error' | 'warning' | 'info';
}
```

### CheckOptions

```typescript
interface CheckOptions {
  /** Language code (default: "en-US") */
  language?: string;

  /** Disabled rule IDs */
  disabledRules?: string[];

  /** Enabled-only rule IDs (if set, only these run) */
  enabledRules?: string[];

  /** Disabled category IDs */
  disabledCategories?: string[];

  /** Use "picky" mode for stricter checking */
  pickyMode?: boolean;

  /** Custom dictionary words to ignore */
  dictionary?: string[];
}
```

---

## API Design

### LanguageToolClient

Low-level client for direct LanguageTool API communication.

```typescript
class LanguageToolClient {
  constructor(options?: {
    baseUrl?: string;      // Default: "http://localhost:8010"
    timeout?: number;      // Default: 5000ms
    maxRetries?: number;   // Default: 2
  });

  /**
   * Check text for grammar/spelling issues
   */
  async check(text: string, options?: CheckOptions): Promise<LanguageToolResponse>;

  /**
   * Get supported languages
   */
  async languages(): Promise<Language[]>;

  /**
   * Health check for server availability
   */
  async health(): Promise<boolean>;
}
```

### GrammarService

High-level service with caching and error handling.

```typescript
class GrammarService {
  constructor(client: LanguageToolClient, options?: {
    cacheSize?: number;    // Default: 1000 entries
    cacheTtl?: number;     // Default: 300000ms (5 min)
  });

  /**
   * Check text with caching
   */
  async check(text: string, options?: CheckOptions): Promise<GrammarCheck>;

  /**
   * Check multiple texts in batch
   */
  async batchCheck(texts: string[], options?: CheckOptions): Promise<GrammarCheck[]>;

  /**
   * Get cached result without network call
   */
  getCached(text: string, language?: string): GrammarCheck | null;

  /**
   * Clear the cache
   */
  clearCache(): void;

  /**
   * Check if server is available
   */
  async isAvailable(): Promise<boolean>;
}
```

---

## Implementation Details

### File Structure

```
packages/core/grammar/
├── src/
│   ├── index.ts                 # Public exports
│   ├── LanguageToolClient.ts    # Low-level API client
│   ├── GrammarService.ts        # High-level service with caching
│   ├── types.ts                 # TypeScript interfaces
│   ├── errors.ts                # Custom error classes
│   ├── utils/
│   │   ├── cache.ts             # LRU cache implementation
│   │   ├── hash.ts              # Text hashing for cache keys
│   │   └── parse.ts             # Response parsing utilities
│   └── __tests__/
│       ├── LanguageToolClient.test.ts
│       ├── GrammarService.test.ts
│       └── fixtures/
│           └── responses.json
├── package.json
├── tsconfig.json
└── README.md
```

### Error Handling

```typescript
// Custom error classes
export class LanguageToolError extends Error {
  constructor(
    message: string,
    public readonly code: ErrorCode,
    public readonly cause?: Error
  ) {
    super(message);
    this.name = 'LanguageToolError';
  }
}

export enum ErrorCode {
  SERVER_UNAVAILABLE = 'SERVER_UNAVAILABLE',
  TIMEOUT = 'TIMEOUT',
  INVALID_LANGUAGE = 'INVALID_LANGUAGE',
  TEXT_TOO_LONG = 'TEXT_TOO_LONG',
  PARSE_ERROR = 'PARSE_ERROR',
}
```

### Caching Strategy

```typescript
// Cache key generation
function getCacheKey(text: string, language: string): string {
  // Use first 100 chars + length + hash for key
  const prefix = text.slice(0, 100);
  const hash = simpleHash(text);
  return `${language}:${text.length}:${prefix}:${hash}`;
}

// LRU cache with TTL
class LRUCache<T> {
  private cache = new Map<string, { value: T; expires: number }>();
  private maxSize: number;
  private ttl: number;

  get(key: string): T | null {
    const entry = this.cache.get(key);
    if (!entry) return null;
    if (Date.now() > entry.expires) {
      this.cache.delete(key);
      return null;
    }
    // Move to end (most recently used)
    this.cache.delete(key);
    this.cache.set(key, entry);
    return entry.value;
  }

  set(key: string, value: T): void {
    // Evict oldest if at capacity
    if (this.cache.size >= this.maxSize) {
      const oldest = this.cache.keys().next().value;
      this.cache.delete(oldest);
    }
    this.cache.set(key, { value, expires: Date.now() + this.ttl });
  }
}
```

### Issue Type Classification

```typescript
function classifyIssue(match: LTMatch): GrammarIssue['type'] {
  const categoryId = match.rule.category.id;

  const typeMap: Record<string, GrammarIssue['type']> = {
    'TYPOS': 'spelling',
    'GRAMMAR': 'grammar',
    'PUNCTUATION': 'punctuation',
    'STYLE': 'style',
    'TYPOGRAPHY': 'typography',
    'CASING': 'style',
    'REDUNDANCY': 'style',
    'SEMANTICS': 'grammar',
  };

  return typeMap[categoryId] || 'grammar';
}

function classifySeverity(match: LTMatch): GrammarIssue['severity'] {
  // Spelling errors and clear grammar issues are errors
  if (match.rule.category.id === 'TYPOS') return 'error';
  if (match.rule.issueType === 'misspelling') return 'error';

  // Style suggestions are info
  if (match.rule.category.id === 'STYLE') return 'info';

  // Default to warning
  return 'warning';
}
```

---

## Docker Configuration

### docker-compose.yml

```yaml
version: '3.8'

services:
  languagetool:
    image: erikvl87/languagetool:latest
    container_name: writeforge-languagetool
    ports:
      - "8010:8010"
    environment:
      - Java_Xms=512m
      - Java_Xmx=2g
      - langtool_languageModel=/ngrams
    volumes:
      - ./ngrams:/ngrams:ro
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8010/v2/check?language=en-US&text=test"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
```

### N-gram Data (Optional)

N-gram data improves accuracy for confused words (e.g., "their" vs "there").

```bash
# Download English n-grams (~8GB download, ~15GB extracted)
mkdir -p ngrams
cd ngrams
wget https://languagetool.org/download/ngram-data/ngrams-en-20150817.zip
unzip ngrams-en-20150817.zip
```

---

## Testing Strategy

### Unit Tests

```typescript
describe('LanguageToolClient', () => {
  describe('check()', () => {
    it('should return issues for text with errors', async () => {
      const client = new LanguageToolClient();
      const result = await client.check('This are a test.');

      expect(result.matches).toHaveLength(1);
      expect(result.matches[0].message).toContain('verb');
    });

    it('should handle empty text', async () => {
      const client = new LanguageToolClient();
      const result = await client.check('');

      expect(result.matches).toHaveLength(0);
    });

    it('should respect disabled rules', async () => {
      const client = new LanguageToolClient();
      const result = await client.check('This are a test.', {
        disabledRules: ['MORFOLOGIK_RULE_EN_US', 'EN_A_VS_AN'],
      });

      // Some rules disabled, may have fewer matches
      expect(result.matches).toBeDefined();
    });

    it('should throw on timeout', async () => {
      const client = new LanguageToolClient({ timeout: 1 });

      await expect(client.check('Test')).rejects.toThrow(LanguageToolError);
    });
  });
});

describe('GrammarService', () => {
  describe('caching', () => {
    it('should return cached result on repeat check', async () => {
      const service = new GrammarService(client);

      const first = await service.check('Hello world');
      const second = await service.check('Hello world');

      expect(first.cached).toBe(false);
      expect(second.cached).toBe(true);
      expect(first.issues).toEqual(second.issues);
    });
  });
});
```

### Integration Tests

```typescript
describe('LanguageTool Integration', () => {
  beforeAll(async () => {
    // Ensure LanguageTool server is running
    const client = new LanguageToolClient();
    const healthy = await client.health();
    if (!healthy) {
      throw new Error('LanguageTool server not available');
    }
  });

  it('should check English text correctly', async () => {
    const service = new GrammarService(new LanguageToolClient());
    const result = await service.check(
      'Their going to the store. Me want food.',
      { language: 'en-US' }
    );

    expect(result.issues.length).toBeGreaterThan(0);
    expect(result.issues.some(i => i.type === 'grammar')).toBe(true);
  });

  it('should support multiple languages', async () => {
    const service = new GrammarService(new LanguageToolClient());

    const german = await service.check('Das ist ein Testt.', { language: 'de-DE' });
    const spanish = await service.check('Esto es una pruebaa.', { language: 'es' });

    expect(german.issues.length).toBeGreaterThan(0);
    expect(spanish.issues.length).toBeGreaterThan(0);
  });
});
```

---

## Performance Considerations

### Latency Targets

| Metric | Target | Measurement |
|--------|--------|-------------|
| Cold check (no cache) | <100ms | Single sentence |
| Warm check (cached) | <5ms | Cache lookup |
| Batch check (10 sentences) | <300ms | Parallel requests |

### Optimization Strategies

1. **Request debouncing:** Don't check on every keystroke; wait 300ms after typing stops
2. **Incremental checking:** Only re-check changed paragraphs
3. **Sentence-level caching:** Cache individual sentences, reassemble
4. **Connection pooling:** Reuse HTTP connections to localhost

---

## Dependencies

```json
{
  "dependencies": {},
  "devDependencies": {
    "typescript": "^5.3.0",
    "vitest": "^1.0.0",
    "@types/node": "^20.0.0"
  }
}
```

Note: Zero runtime dependencies. Uses native `fetch` for HTTP.

---

## Acceptance Criteria

- [ ] LanguageToolClient can check text and return parsed issues
- [ ] GrammarService provides caching with configurable TTL
- [ ] All issue types correctly classified (grammar/spelling/punctuation/style)
- [ ] Server unavailability handled gracefully with clear error
- [ ] <100ms latency for single sentence checks
- [ ] 85% unit test coverage
- [ ] Integration tests pass against live LanguageTool server

---

## Open Questions

1. **Embedded vs. Docker:** Should desktop apps embed LanguageTool JAR or require Docker?
   - **Recommendation:** Docker for development, embedded for distribution

2. **N-gram data:** Bundle n-gram data or optional download?
   - **Recommendation:** Optional download (8GB is too large for default install)

3. **Multi-language support:** Check multiple languages simultaneously?
   - **Recommendation:** Defer to P1; single language per check for MVP

---

**Document Version:** 1.0.0
**Created:** January 2026
**Author:** AI Assistant
